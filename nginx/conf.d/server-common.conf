# Common server configuration for both HTTP and HTTPS servers

client_max_body_size 100M;

# Security headers
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;
add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:;" always;

# Health check endpoint
location /health {
    access_log off;
    return 200 "healthy\n";
    add_header Content-Type text/plain;
}

# API routes - proxy to Django backend
location /api/ {
    limit_req zone=api burst=20 nodelay;

    proxy_pass http://django_backend;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Timeout settings
    proxy_connect_timeout 30s;
    proxy_send_timeout 30s;
    proxy_read_timeout 30s;

    # Disable buffering for real-time responses
    proxy_buffering off;
    proxy_request_buffering off;
}

# Django Admin routes
location /admin/ {
    limit_req zone=api burst=10 nodelay;

    proxy_pass http://django_backend;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# Media files - serve from volume
location /media/ {
    alias /media/;
    expires 1y;
    add_header Cache-Control "public, immutable";
    add_header Vary "Accept-Encoding";

    # Enable CORS for media files
    add_header Access-Control-Allow-Origin "*";
    add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS";

    # Security for uploaded files
    location ~* \.(php|php5|phtml|pl|py|jsp|asp|sh|cgi)$ {
        return 403;
    }

    # Optimize image serving
    location ~* \.(jpg|jpeg|png|gif|ico|svg|webp)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
    }

    # Video files
    location ~* \.(mp4|webm|ogg|avi|mov)$ {
        expires 1w;
        add_header Cache-Control "public";

        # Enable range requests for video
        add_header Accept-Ranges bytes;
    }
}

# Static files - serve React build (assets)
location /static/ {
    limit_req zone=static burst=100 nodelay;

    alias /usr/share/nginx/html/static/;
    expires 1y;
    add_header Cache-Control "public, immutable";
    gzip_static on;

    # Precompressed files
    location ~* \.(js|css)$ {
        try_files $uri.gz $uri =404;
        add_header Content-Encoding gzip;
        add_header Vary "Accept-Encoding";
    }
}

# React SPA - serve index.html for all routes
location / {
    root /usr/share/nginx/html;
    index index.html;
    try_files $uri $uri/ /index.html;

    # Cache control for HTML
    location ~* \.(html)$ {
        expires -1;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
    }

    # Cache for assets
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}

# Block access to sensitive files
location ~ /\.
{
    deny all;
    access_log off;
    log_not_found off;
}

location ~ ~$ {
    deny all;
    access_log off;
    log_not_found off;
}

